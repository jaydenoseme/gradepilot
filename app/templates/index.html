{% extends 'layout.html' %}

{% block content %}

    {% set scale_names = {
    'standard_4': 'Standard 4.0',
    'honors': 'Honors (+0.5)',
    'ap_ib': 'AP/IB (+1.0)',
    'custom': 'Custom',
    'weighted_5': 'Weighted 5.0',
    'standard': 'Standard',
    'weighted_6': 'Weighted 6.0',
    'college_4': 'College 4.0 (Variants)',
    'college_plus_minus': 'College Plus/Minus',
    'percentage': 'Percentage'
    } %}

    {% set format_names = {
    'simple': 'Simple',
    'plus_minus': 'Plus/Minus',
    'letter_only': 'Letter Only',
    'custom': 'Custom',
    'college_plus_minus': 'College Plus/Minus',
    'percentage': 'Percentage Format'
    } %}

    <div class="grades-list">
        <h2>Your Grades</h2>
        <h2>
            <p>Logged in as: {{ current_user.username }}</p>
        </h2>
        {% if gpa is not none %}
            <div class="gpa-display">
                <h3>Current GPA: {{ "%.2f"|format(gpa) }}</h3>
            </div>
        {% endif %}
        {% if gpa_scale and grade_format %}
            <div class="gpa-display">
                <p><strong>GPA Scale:</strong> {{ scale_names[gpa_scale] if gpa_scale in scale_names else gpa_scale }}</p>
                <p><strong>Grade Format:</strong> {{ format_names[grade_format] if grade_format in format_names else grade_format }}</p>
            </div>
        {% endif %}
        {% if grades %}
            <button id="toggleTableSize" class="btn btn-expand mb-2">Expand Table</button>
            <div class="grades-scroll-container">
                <table class="table table-striped grades-table">
                    <thead>
                        <tr>
                            <th>Subject</th>
                            <th>Grade (Numeric)</th>
                            <th>Grade (Letter)</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for grade in grades %}
                            <tr>
                                <td>{{ grade.subject }}</td>
                                <td>{{ "%.2f"|format(grade.grade) }}</td>
                                <td>{{ grade.letter }}</td>
                                <td>{{ grade.date.strftime('%b %-d %Y') }}</td>
                                <td class="actions-cell">
                                    {% if current_user.is_authenticated %}
                                        <a href="{{ url_for('main.edit_grade', grade_id=grade.id) }}" class="btn btn-edit">Edit</a>
                                        <form method="POST" action="{{ url_for('main.delete_grade', grade_id=grade.id) }}" style="display:inline;">
                                            {{ delete_form.hidden_tag() }}
                                            <button type="submit" class="btn btn-delete" onclick="return confirm('Are you sure you want to delete this grade?');">Delete</button>
                                        </form>
                                    {% else %}
                                        <form method="POST" action="{{ url_for('main.delete_guest_grade', index=loop.index0) }}" style="display:inline;">
                                            <button type="submit" class="btn btn-delete" onclick="return confirm('Are you sure you want to delete this grade?');" style="margin-right:10px;">Delete</button>
                                        </form>

                                        <em style="font-size: 0.9rem; color: #555;">Log in to edit grade</em>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% if grades|length > 5 %}
                <p class="scroll-note">Scroll to see more grades...</p>
            {% endif %}
        {% else %}
            <p>No grades yet.</p>
        {% endif %}

        <div class="add-grade-link mt-3">
            <a href="{{ url_for('main.add_grade') }}" class="btn btn-add">Add New Grade</a>
        </div>
    </div>

    <div class="dashboard-flex-container">
        <a href="{{ url_for('main.trends') }}" class="gpa-link-card">
            <div class="gpa-trend">
                <h3>GPA Trend</h3>
                <div class="graph-container">
                    <canvas id="gpaTrendChart"></canvas>
                </div>
            </div>
        </a>
        <div class="right-panel">
            <div class="simulate-scenarios">
                <h3>Want to simulate scenarios?</h3>
                <div class="tooltip-hover-wrapper">
                    <button class="btn btn-disabled" type="button" disabled>Go to Simulator</button>
                </div>
            </div>
            <div class="export-transcript">
                <h3>Want to export this into a transcript?</h3>
                <div class="tooltip-hover-wrapper">
                    <button class="btn btn-disabled" type="button" disabled>Export Transcript</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const toggleButton = document.getElementById('toggleTableSize');
            const scrollContainer = document.querySelector('.grades-scroll-container');

            if (toggleButton && scrollContainer) {
                toggleButton.addEventListener('click', function() {
                    scrollContainer.classList.toggle('expanded');
                    this.textContent = scrollContainer.classList.contains('expanded') ? 'Minimize Table' : 'Expand Table';
                });
            }

            const chartCanvas = document.getElementById('gpaTrendChart');
            if (chartCanvas) {
                const ctx = chartCanvas.getContext('2d');

                const gpaValues = {{ values | tojson }};
                const maxGPA = Math.max(...gpaValues);
                const yAxisMax = maxGPA > 4.0 ? Math.ceil(maxGPA * 10) / 10 + 0.2 : 4.0;

                const gpaTrendChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: {{ labels | tojson }},
                        datasets: [{
                            label: 'Average Grade Trend',
                            data: gpaValues,
                            fill: true,
                            borderColor: '#0a1f44',
                            backgroundColor: 'rgba(10, 31, 68, 0.1)',
                            tension: 0.3,
                            pointRadius: 4,
                            pointBackgroundColor: '#0a1f44',
                            borderWidth: 2,
                            clip: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: {
                            padding: {
                                top: 40,
                                bottom: 10,
                                left: 10,
                                right: 10
                            }
                        },
                        scales: {
                            y: {
                                min: 0,
                                max: yAxisMax,
                                ticks: {
                                    stepSize: 0.5,
                                    callback: val => val.toFixed(1)
                                },
                                title: {
                                    display: true,
                                    text: 'GPA'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Date'
                                },
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 30,
                                    autoSkip: true,
                                    maxTicksLimit: 10
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return 'GPA: ' + context.parsed.y.toFixed(2);
                                    }
                                }
                            }
                        }
                    }
                });
            }
        });
    </script>

    <style>
    /* Your existing styles here - unchanged */
        .scroll-note {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 1rem;
        }

        .dashboard-flex-container {
            display: flex;
            gap: 2rem;
            margin-top: 2rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .gpa-link-card {
            text-decoration: none;
            color: inherit;
            flex: 1 1 600px;
            max-width: 600px;
            transition: transform 0.25s ease, box-shadow 0.25s ease;
            cursor: pointer;
        }

        .gpa-link-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
        }

        .gpa-link-card:hover .gpa-trend {
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            background-color: #eef1fb;
        }

        .gpa-trend {
            background: #f5f7ff;
            padding: 1rem;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgb(0 0 0 / 0.1);
            height: 320px;
            display: flex;
            flex-direction: column;
            transition: box-shadow 0.3s ease;
        }

        .graph-container {
            flex: 1 1 auto;
            width: 100%;
            position: relative;
        }

        canvas#gpaTrendChart {
            width: 100% !important;
            height: 300px !important;
            display: block;
        }

        .right-panel {
            flex: 1 1 300px;
            max-width: 300px;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .simulate-scenarios,
        .export-transcript {
            background: #f9f9f9;
            padding: 1rem;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgb(0 0 0 / 0.07);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .simulate-scenarios h3,
        .export-transcript h3 {
            margin-bottom: 1rem;
        }

        .btn-secondary {
            background-color: #0a1f44;
            color: white;
            border: none;
            padding: 0.5rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s ease;
            text-decoration: none;
        }

        .btn-secondary:hover {
            background-color: #071632;
        }

        .btn {
            padding: 0.4rem 1rem;
            font-size: 0.95rem;
            border-radius: 6px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            text-decoration: none;
            transition: background-color 0.3s ease;
        }

        .btn-add {
            background-color: #28a745;
            color: white;
        }

        .btn-add:hover {
            background-color: #218838;
        }

        .btn-expand {
            background-color: #6c757d;
            color: white;
        }

        .btn-expand:hover {
            background-color: #5a6268;
        }

        .btn-disabled {
            background-color: #cccccc;
            color: #666666;
            border: none;
            padding: 0.5rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: not-allowed;
            opacity: 0.7;
            text-decoration: none;
            box-shadow: none;
            transition: none;
        }

        .grades-scroll-container {
            max-height: 300px;
            overflow-y: auto;
            transition: max-height 0.4s ease;
            position: relative;
            z-index: 1;
        }

        .grades-scroll-container.expanded {
            max-height: none;
        }

        .gpa-display {
            margin-bottom: 1rem;
            background-color: #eef1fb;
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
            text-align: center;
            font-weight: 600;
            color: #0a1f44;
        }

        .tooltip-hover-wrapper {
            position: relative;
            display: inline-block;
            overflow: visible !important;
            z-index: 10000;
        }

        .tooltip-hover-msg {
            visibility: hidden;
            width: 160px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 6px 10px;
            position: absolute;
            z-index: 10001;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.85rem;
            pointer-events: none;
        }

        .tooltip-hover-msg::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }

        .tooltip-hover-wrapper:hover .tooltip-hover-msg {
            visibility: visible;
            opacity: 1;
        }
    </style>

{% endblock %}
